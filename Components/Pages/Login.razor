@page "/"
@page "/login"
@using GlobalApp.Services
@using Microsoft.Maui.Storage
@inject UserDatabase UserDb
@inject NavigationManager Nav
@inject SessionService Session

<div class="login-container">
    <div class="login-box">
        <h2>Iniciar Sesión</h2>

        <input @bind="username" placeholder="Usuario" />
        <input @bind="password" placeholder="Contraseña" type="password" />

        <button @onclick="OnLoginClicked">Entrar</button>

        @if (!string.IsNullOrEmpty(error))
        {
            <p class="login-error">@error</p>
        }

        <!-- Enlace a la pantalla de creación de nuevo usuario -->
        <p>¿No tienes una cuenta? <a href="/newuser">Crear nueva cuenta</a></p>
    </div>
</div>

@code {
    private string username = "";
    private string password = "";
    private string? error;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (Preferences.Default.Get("isLogged", false))
            {
                Nav.NavigateTo("/home", true);
            }
        }
    }

    private async Task OnLoginClicked()
    {
        var user = await UserDb.GetUserAsync(username, password);
        if (user != null)
        {
            Session.Login(username);
            Nav.NavigateTo("/home");
        }
        else
        {
            error = "Credenciales incorrectas";
        }
    }
}
