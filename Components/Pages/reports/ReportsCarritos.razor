@page "/reports/carritos"
@using System.Text
@using GlobalApp.Models
@using GlobalApp.Services
@inject CartService CartService
@inject NavigationManager Nav

<h3>Reporte de Carritos</h3>

<button class="btn btn-primary mb-3" @onclick="ExportToCsv">Exportar a CSV</button>

<table class="table table-striped table-responsive">
    <thead>
        <tr>
            <th>Id</th>
            <th>Usuario</th>
            <th>ASIN</th>
            <th>Título</th>
            <th>Precio</th>
            <th>Cantidad</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in data)
        {
            <tr>
                <td>@item.Id</td>
                <td>@item.Username</td>
                <td>@item.Asin</td>
                <td>@item.Title</td>
                <td>@item.Price</td>
                <td>@item.Quantity</td>
            </tr>
        }
    </tbody>
</table>

<button class="btn btn-secondary" @onclick="GoBack">Volver</button>

@code {
    private List<CartItem> data = new();

    protected override async Task OnInitializedAsync()
    {
        data = await CartService.GetCartItemsAsync();
    }

    private async Task ExportToCsv()
    {
        var delimiter = ";";
        var sb = new StringBuilder();

        // Cabecera
        sb.AppendLine(string.Join(delimiter, new[] { "Id", "Usuario", "ASIN", "Título", "Precio", "Cantidad" }));

        // Filas
        foreach (var item in data)
        {
            // Escapar comillas dobles en texto
            var title = item.Title.Replace("\"", "\"\"");
            sb.AppendLine($"{item.Id}{delimiter}\"{item.Username}\"{delimiter}\"{item.Asin}\"{delimiter}\"{title}\"{delimiter}{item.Price}{delimiter}{item.Quantity}");
        }

        // Guardar archivo CSV
        var filename = "reporte_carritos.csv";
        var path = Path.Combine(FileSystem.AppDataDirectory, filename);
        File.WriteAllText(path, sb.ToString(), Encoding.UTF8);

        // Compartir / abrir
        try
        {
            await Share.RequestAsync(new ShareFileRequest
            {
                Title = "Exportar reporte de carritos",
                File = new ShareFile(path)
            });
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK");
        }
    }

    void GoBack() => Nav.NavigateTo("/reports");
}
